name: üöÄ Enterprise AKS + DevOps Platform CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  security-events: write

env:
  TF_VERSION: 1.13.3
  TF_ROOT_DIR: project4-enterprise-aks-devops-platform
  IMAGE_NAME: sampleapp
  ACR_NAME: devopsacr001
  AKS_CLUSTER_NAME: devops-aks
  AKS_RESOURCE_GROUP: rg-devsecops-dev

jobs:
  terraform-validate:
    name: üß© Terraform Validate + Security Scan
    runs-on: ubuntu-latest

    steps:
      # ‚úÖ Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # ‚úÖ Setup Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      # ‚úÖ Diagnostic
      - name: Diagnostic ‚Äì Show folder structure
        run: |
          echo "=== Folder Tree ==="
          ls -R ./${{ env.TF_ROOT_DIR }}

      # ‚úÖ Terraform Init + Validate
      - name: Terraform Init (No Backend)
        run: terraform init -backend=false
        working-directory: ${{ env.TF_ROOT_DIR }}/infrastructure/aks

      - name: Terraform Validate
        run: terraform validate
        working-directory: ${{ env.TF_ROOT_DIR }}/infrastructure/aks

      # ‚úÖ Checkov SARIF
      - name: Checkov Scan (SARIF)
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: ${{ env.TF_ROOT_DIR }}/infrastructure/aks
          framework: terraform
          soft_fail: true
          output_format: sarif
          output_file_path: results.sarif

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif

      # ‚úÖ Generate Checkov JSON
      - name: Generate Checkov JSON Report
        continue-on-error: true
        run: |
          echo "üßÆ Generating Checkov JSON..."
          docker run --rm \
            -v $(pwd):/tf ghcr.io/bridgecrewio/checkov:latest \
            -d /tf/${{ env.TF_ROOT_DIR }}/infrastructure/aks \
            --framework terraform \
            --output json \
            --output-file-path /tf/checkov_report.json
        working-directory: ${{ github.workspace }}

      # ‚úÖ Install OPA and Run Policies
      - name: Run OPA Policy Validation
        continue-on-error: true
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64
          chmod +x opa && sudo mv opa /usr/local/bin/
          terraform show -json > plan.json || true
          opa eval --data ${{ env.TF_ROOT_DIR }}/policies/opa --input plan.json "data.terraform.policy.deny" --format=json > opa_result.json || true
        working-directory: ${{ github.workspace }}

      # ‚úÖ Build Unified Inline Compliance Dashboard (SAFE)
      - name: Build Unified Inline Compliance Dashboard
        continue-on-error: true
        shell: bash
        run: |
          echo "üß± Building single unified compliance dashboard..."

          # --- Safety guards ---
          if [ ! -s checkov_report.json ]; then
            echo "‚ö†Ô∏è checkov_report.json not found or empty, creating dummy."
            echo '{"summary":{"passed":0,"failed":0,"skipped":0}}' > checkov_report.json
          fi

          if [ ! -s opa_result.json ]; then
            echo "‚ö†Ô∏è opa_result.json not found or empty, creating dummy."
            echo '{"result":[{"expressions":[{"value":[]}]}]}' > opa_result.json
          fi

          # --- Safe metrics extraction ---
          PASSED=$(jq -r '.summary.passed // 0' checkov_report.json)
          FAILED=$(jq -r '.summary.failed // 0' checkov_report.json)
          SKIPPED=$(jq -r '.summary.skipped // 0' checkov_report.json)
          TOTAL=$((PASSED + FAILED + SKIPPED))
          if [ "$TOTAL" -eq 0 ]; then TOTAL=1; fi

          OPA_VIOLATIONS=$(jq '.result[0].expressions[0].value | length' opa_result.json 2>/dev/null || echo 0)
          OPA_VIOLATIONS=${OPA_VIOLATIONS:-0}

          COMPLIANCE=$((100 * PASSED / TOTAL))
          if [ "$COMPLIANCE" -ge 90 ]; then GRADE="A"
          elif [ "$COMPLIANCE" -ge 75 ]; then GRADE="B"
          elif [ "$COMPLIANCE" -ge 60 ]; then GRADE="C"
          elif [ "$COMPLIANCE" -ge 40 ]; then GRADE="D"
          else GRADE="F"; fi

          # --- Generate HTML ---
          echo "<html><head><title>Unified DevSecOps Compliance Dashboard</title>
          <style>
            body{font-family:Arial,Helvetica,sans-serif;background:#f4f6f9;margin:30px;}
            h1{text-align:center;color:#1a237e;}
            h2{color:#0d47a1;margin-top:40px;}
            table{border-collapse:collapse;width:60%;margin-bottom:20px;}
            th,td{border:1px solid #ccc;padding:8px;text-align:left;}
            th{background:#283593;color:white;}
            .passed{color:green;font-weight:bold;}
            .failed{color:red;font-weight:bold;}
            .skipped{color:orange;font-weight:bold;}
            .section{padding:20px;background:#fff;border-radius:10px;box-shadow:0 0 8px rgba(0,0,0,0.1);margin-bottom:30px;}
            .pie{width:220px;height:220px;border-radius:50%;margin:20px auto;
                background:conic-gradient(green 0% calc(${PASSED}/${TOTAL}*100%),
                                          red calc(${PASSED}/${TOTAL}*100%) calc((${PASSED}+${FAILED})/${TOTAL}*100%),
                                          orange calc((${PASSED}+${FAILED})/${TOTAL}*100%) 100%);}
            .bar{width:60%;height:30px;border-radius:10px;margin:20px auto;background:#ddd;}
            .fill{height:100%;border-radius:10px;text-align:center;color:white;font-weight:bold;}
            .grade{font-size:22px;margin-top:5px;text-align:center;}
            pre{background:#f8f9fa;border:1px solid #ccc;padding:10px;border-radius:6px;overflow:auto;max-height:500px;}
          </style>
          </head><body>

          <h1>üåê Enterprise AKS DevSecOps Compliance Dashboard</h1>

          <div class='section' style='text-align:center;'>
            <h2>üìä Overall Compliance</h2>
            <div class='bar'>
              <div class='fill' style='width:${COMPLIANCE}%;background:${COMPLIANCE}>=80?\"green\":(${COMPLIANCE}>=60?\"orange\":\"red\");'>
                ${COMPLIANCE}%
              </div>
            </div>
            <div class='grade'>Compliance Grade: <b>${GRADE}</b></div>
          </div>

          <div class='section'>
            <h2>‚úÖ Checkov Terraform Security Summary</h2>
            <div class='pie'></div>
            <table>
              <tr><th>Status</th><th>Count</th></tr>
              <tr><td class='passed'>‚úÖ Passed</td><td>$PASSED</td></tr>
              <tr><td class='failed'>‚ùå Failed</td><td>$FAILED</td></tr>
              <tr><td class='skipped'>‚ö†Ô∏è Skipped</td><td>$SKIPPED</td></tr>
              <tr><td><b>Total</b></td><td><b>$TOTAL</b></td></tr>
            </table>
            <h3>Detailed Checkov Results (JSON)</h3>
            <pre>$(jq '.' checkov_report.json)</pre>
          </div>

          <div class='section'>
            <h2>üß† OPA Policy Validation Summary</h2>
            <p>Total Violations: <b class='failed'>$OPA_VIOLATIONS</b></p>
            <h3>OPA Evaluation Output (JSON)</h3>
            <pre>$(jq '.' opa_result.json)</pre>
          </div>

          <div style='text-align:center;color:#555;margin-top:30px;'>
            <hr><p>Generated automatically by Enterprise AKS + DevSecOps CI/CD ‚ú®</p>
          </div>

          </body></html>" > compliance_dashboard.html

          echo "‚úÖ compliance_dashboard.html generated successfully"
        working-directory: ${{ github.workspace }}

      # ‚úÖ Upload Artifact
      - name: Upload Unified Inline Dashboard
        uses: actions/upload-artifact@v4
        with:
          name: compliance-dashboard
          path: ${{ github.workspace }}/compliance_dashboard.html

      - name: Print Summary
        run: |
          echo "‚úÖ Unified Inline Dashboard generated successfully!"
          echo "üìÑ Download artifact: compliance_dashboard.html"


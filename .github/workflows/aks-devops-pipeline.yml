name: üöÄ Enterprise AKS + DevSecOps Platform CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  security-events: write

env:
  TF_VERSION: 1.13.3
  TF_ROOT_DIR: project4-enterprise-aks-devops-platform
  IMAGE_NAME: sampleapp
  ACR_NAME: devopsacr001
  AKS_CLUSTER_NAME: devops-aks
  AKS_RESOURCE_GROUP: rg-devsecops-dev

jobs:
  terraform-validate:
    name: üß© Terraform Validate + Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: üßæ Checkout repository
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: üìÇ Diagnostic ‚Äì Show folder structure
        run: ls -R ./${{ env.TF_ROOT_DIR }}

      - name: üß± Terraform Init
        run: terraform init -backend=false
        working-directory: ${{ env.TF_ROOT_DIR }}/infrastructure/aks

      - name: üîç Terraform Validate
        run: terraform validate
        working-directory: ${{ env.TF_ROOT_DIR }}/infrastructure/aks

      - name: üß† Checkov Security Scan (SARIF)
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: ${{ env.TF_ROOT_DIR }}/infrastructure/aks
          framework: terraform
          soft_fail: true
          output_format: sarif
          output_file_path: results.sarif

      - name: üì§ Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif

      # ‚úÖ FIXED: Checkov JSON output now correctly saved to workspace
      - name: üßÆ Generate Checkov JSON Report
        continue-on-error: true
        run: |
          echo "üßÆ Generating Checkov JSON report..."
          docker run --rm \
            -v $(pwd):/tf ghcr.io/bridgecrewio/checkov:latest \
            -d /tf/${{ env.TF_ROOT_DIR }}/infrastructure/aks \
            --framework terraform \
            --output json \
            --output-file-path /tf/checkov_report.json || true

          echo "‚úÖ Verifying report..."
          if [ -s checkov_report.json ]; then
            echo "‚úÖ Found checkov_report.json successfully"
          else
            echo "‚ö†Ô∏è Report missing, creating dummy JSON"
            echo '{"summary":{"passed":0,"failed":0,"skipped":0}}' > checkov_report.json
          fi
          head -20 checkov_report.json || true
        working-directory: ${{ github.workspace }}

      - name: üîí Run OPA Policy Validation
        continue-on-error: true
        run: |
          echo "üîç Installing OPA and validating policies..."
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64
          chmod +x opa && sudo mv opa /usr/local/bin/
          terraform show -json > plan.json || true
          opa eval --data ${{ env.TF_ROOT_DIR }}/policies/opa --input plan.json \
            "data.terraform.policy.deny" --format=json > opa_result.json || true
        working-directory: ${{ github.workspace }}

      # üß± Build HTML Dashboard with Pie Chart + Trend Indicator
      - name: üß± Build Advanced Compliance Dashboard
        continue-on-error: true
        shell: bash
        run: |
          set +e
          export LANG=en_US.UTF-8
          export LC_ALL=en_US.UTF-8
          echo "üß± Building unified compliance dashboard..."
          sudo apt-get update -y && sudo apt-get install -y jq

          WORK_DIR="${{ github.workspace }}"
          DASHBOARD_PATH="${WORK_DIR}/compliance_dashboard.html"

          [ -s "${WORK_DIR}/checkov_report.json" ] || echo '{"summary":{"passed":0,"failed":0,"skipped":0}}' > "${WORK_DIR}/checkov_report.json"
          [ -s "${WORK_DIR}/opa_result.json" ] || echo '{"result":[{"expressions":[{"value":[]}]}]}' > "${WORK_DIR}/opa_result.json"

          PASSED=$(jq -r '.summary.passed // 0' checkov_report.json)
          FAILED=$(jq -r '.summary.failed // 0' checkov_report.json)
          SKIPPED=$(jq -r '.summary.skipped // 0' checkov_report.json)
          TOTAL=$((PASSED + FAILED + SKIPPED))
          [ "$TOTAL" -eq 0 ] && TOTAL=1

          OPA_VIOLATIONS=$(jq '.result[0].expressions[0].value | length' opa_result.json)
          COMPLIANCE=$((100 * PASSED / TOTAL))

          if [ "$COMPLIANCE" -ge 90 ]; then GRADE="A"; COLOR="green";
          elif [ "$COMPLIANCE" -ge 75 ]; then GRADE="B"; COLOR="limegreen";
          elif [ "$COMPLIANCE" -ge 60 ]; then GRADE="C"; COLOR="orange";
          elif [ "$COMPLIANCE" -ge 40 ]; then GRADE="D"; COLOR="orangered";
          else GRADE="F"; COLOR="red"; fi

          cat <<EOF > "${DASHBOARD_PATH}"
          <html>
          <head>
            <meta charset="UTF-8">
            <title>Unified DevSecOps Compliance Dashboard</title>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
          </head>
          <body style='font-family:Arial,Helvetica,sans-serif;background:#f9fafc;margin:30px;'>
            <h1 style='text-align:center;color:#1a237e;'>üåê Enterprise AKS DevSecOps Compliance Dashboard</h1>

            <table border='1' cellspacing='0' cellpadding='6' style='border-collapse:collapse;width:75%;margin:auto;'>
              <tr><th>‚úÖ Passed</th><th>‚ùå Failed</th><th>‚ö†Ô∏è Skipped</th><th>üß† OPA Violations</th><th>üìà Compliance %</th><th>üèÖ Grade</th></tr>
              <tr>
                <td style='color:green;'>${PASSED}</td>
                <td style='color:red;'>${FAILED}</td>
                <td style='color:orange;'>${SKIPPED}</td>
                <td style='color:red;'>${OPA_VIOLATIONS}</td>
                <td><b>${COMPLIANCE}%</b></td>
                <td><b>${GRADE}</b></td>
              </tr>
            </table>

            <div style='width:300px;margin:auto;margin-top:40px;'>
              <canvas id="compliancePie"></canvas>
            </div>

            <div style='text-align:center;margin-top:30px;font-size:18px;'>
              üìä Compliance Trend:
              <b style='color:${COLOR};'>
                $([ "$COMPLIANCE" -ge 60 ] && echo "üìà Improving") || echo "üìâ Needs Attention"
              </b>
            </div>

            <p style='text-align:center;color:#777;margin-top:40px;'>
              Generated automatically by <b>Enterprise AKS + DevSecOps CI/CD ‚ú®</b>
            </p>

            <script>
              const ctx = document.getElementById('compliancePie');
              new Chart(ctx, {
                type: 'pie',
                data: {
                  labels: ['Passed', 'Failed', 'Skipped'],
                  datasets: [{
                    data: [${PASSED}, ${FAILED}, ${SKIPPED}],
                    backgroundColor: ['#2ecc71','#e74c3c','#f1c40f']
                  }]
                },
                options: {
                  plugins: {
                    legend: { position: 'bottom' },
                    title: {
                      display: true,
                      text: 'Terraform + OPA Compliance Overview'
                    }
                  }
                }
              });
            </script>
          </body></html>
          EOF

          echo "‚úÖ compliance_dashboard.html generated successfully"

      - name: üì§ Upload Unified Dashboard Artifact
        uses: actions/upload-artifact@v4
        with:
          name: compliance-dashboard
          path: ${{ github.workspace }}/compliance_dashboard.html
          if-no-files-found: warn

      - name: ‚úÖ Print Summary
        run: |
          echo "‚úÖ Dashboard with Pie Chart successfully generated and uploaded!"
          echo "üìÑ Artifact name: compliance-dashboard"


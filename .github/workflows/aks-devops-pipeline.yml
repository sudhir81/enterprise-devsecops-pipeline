name: üöÄ Enterprise AKS + DevSecOps Platform CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  TF_VERSION: 1.13.3
  TF_ROOT_DIR: project4-enterprise-aks-devops-platform/infrastructure/aks
  IMAGE_NAME: sampleapp
  ACR_NAME: devopsacr001
  AKS_CLUSTER_NAME: devops-aks
  AKS_RESOURCE_GROUP: rg-devsecops-dev
  # Optionally set defaults for TF vars here (can be overridden by secrets or repo variables)
  TF_VAR_environment: dev
  TF_VAR_prefix: myprefix

jobs:
  terraform-validate:
    name: üß© Terraform Validate + Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: üõ†Ô∏è Checkout Repository
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: üîê Azure Login (Service Principal)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          enable-AzPSSession: false
          environment: azurecloud
          allow-no-subscriptions: false

      - name: üåç Export ARM and TF_VAR variables from creds + repo env
        id: export_env
        run: |
          # parse Azure creds JSON into environment variables for Terraform
          echo "$AZURE_CREDENTIALS" > /tmp/azcreds.json || true
          if [ -s /tmp/azcreds.json ]; then
            echo "ARM_CLIENT_ID=$(jq -r .clientId /tmp/azcreds.json)" >> $GITHUB_ENV
            echo "ARM_CLIENT_SECRET=$(jq -r .clientSecret /tmp/azcreds.json)" >> $GITHUB_ENV
            echo "ARM_SUBSCRIPTION_ID=$(jq -r .subscriptionId /tmp/azcreds.json)" >> $GITHUB_ENV
            echo "ARM_TENANT_ID=$(jq -r .tenantId /tmp/azcreds.json)" >> $GITHUB_ENV
            rm /tmp/azcreds.json
          fi

          # ensure TF_VARs required by your module are set (export to GITHUB_ENV)
          # Provide defaults from workflow env variables, but allow repository secrets/vars to override.
          echo "TF_VAR_acr_name=${{ env.ACR_NAME }}" >> $GITHUB_ENV
          echo "TF_VAR_image_name=${{ env.IMAGE_NAME }}" >> $GITHUB_ENV
          echo "TF_VAR_aks_cluster_name=${{ env.AKS_CLUSTER_NAME }}" >> $GITHUB_ENV
          echo "TF_VAR_aks_resource_group=${{ env.AKS_RESOURCE_GROUP }}" >> $GITHUB_ENV
          # preserve any TF_VAR_environment or TF_VAR_prefix already set in env
          echo "TF_VAR_environment=${TF_VAR_environment:-${{ env.TF_VAR_environment }}}" >> $GITHUB_ENV
          echo "TF_VAR_prefix=${TF_VAR_prefix:-${{ env.TF_VAR_prefix }}}" >> $GITHUB_ENV

      - name: üöÄ Terraform Init
        run: |
          cd ${{ env.TF_ROOT_DIR }}
          terraform init -upgrade

      - name: üßæ Terraform Validate
        run: |
          cd ${{ env.TF_ROOT_DIR }}
          terraform validate

      - name: üìã Terraform Plan (no-interactive)
        run: |
          cd ${{ env.TF_ROOT_DIR }}
          # create a plan file; uses TF_VAR_* environment variables set above
          terraform plan -out=tfplan -input=false

      - name: üß† Run Checkov Security Scan
        run: |
          # Run Checkov against the terraform folder (use $(pwd) resolution)
          docker run --rm \
            -v "${{ github.workspace }}":/tf ghcr.io/bridgecrewio/checkov:latest \
            -d /tf/${{ env.TF_ROOT_DIR }} \
            --framework terraform \
            --output json \
            --output-file-path /tf/checkov_report.json

      - name: üîç Installing OPA and validating policies
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64
          chmod +x opa
          # if nothing to evaluate, ensure opa_result.json is present to avoid failures
          if [ ! -f checkov_report.json ]; then
            echo '{"summary":{"passed":0,"failed":0,"skipped":0}}' > checkov_report.json
          fi
          # Adjust policy/data paths as needed for your repo
          ./opa eval --format=json --data project4-enterprise-aks-devops-platform/policies/opa \
            --input checkov_report.json "data.terraform.policy.deny" > opa_result.json || true

      - name: üß± Building unified compliance dashboard
        run: |
          sudo apt-get update -qq && sudo apt-get install -y jq

          WORK_DIR="${{ github.workspace }}"
          DASHBOARD_PATH="$WORK_DIR/compliance_dashboard.html"
          echo "üìÇ WORK_DIR: $WORK_DIR"
          echo "üìÑ Target dashboard path: $DASHBOARD_PATH"

          # Safe defaults when reports are missing
          [ ! -s "$WORK_DIR/checkov_report.json" ] && echo '{"summary":{"passed":0,"failed":0,"skipped":0}}' > "$WORK_DIR/checkov_report.json"
          [ ! -s "$WORK_DIR/opa_result.json" ] && echo '{"result":[{"expressions":[{"value":[]}]}]}' > "$WORK_DIR/opa_result.json"

          PASSED=$(jq -r '.summary.passed // 0' "$WORK_DIR/checkov_report.json")
          FAILED=$(jq -r '.summary.failed // 0' "$WORK_DIR/checkov_report.json")
          SKIPPED=$(jq -r '.summary.skipped // 0' "$WORK_DIR/checkov_report.json")
          TOTAL=$((PASSED + FAILED + SKIPPED))
          [ "$TOTAL" -eq 0 ] && TOTAL=1
          OPA_VIOLATIONS=$(jq '.result[0].expressions[0].value | length' "$WORK_DIR/opa_result.json" 2>/dev/null || echo 0)
          COMPLIANCE=$((100 * PASSED / TOTAL))

          cat > "$DASHBOARD_PATH" <<EOF
          <html><head><title>Unified Compliance Dashboard</title>
          <style>
            body{font-family:Arial;background:#f7f9fb;margin:30px;}
            h1{text-align:center;color:#0d47a1;}
            .section{background:#fff;padding:20px;border-radius:10px;margin-bottom:30px;
              box-shadow:0 2px 8px rgba(0,0,0,0.1);}
            table{width:60%;border-collapse:collapse;margin:auto;}
            th,td{border:1px solid #ddd;padding:8px;text-align:center;}
            th{background:#1976d2;color:white;}
            .passed{color:green;font-weight:bold;}
            .failed{color:red;font-weight:bold;}
            .skipped{color:orange;font-weight:bold;}
          </style></head><body>
          <h1>üåê Enterprise AKS + DevSecOps Compliance Dashboard</h1>
          <div class="section">
            <h2>‚úÖ Checkov Terraform Summary</h2>
            <table>
              <tr><th>Status</th><th>Count</th></tr>
              <tr><td class='passed'>Passed</td><td>$PASSED</td></tr>
              <tr><td class='failed'>Failed</td><td>$FAILED</td></tr>
              <tr><td class='skipped'>Skipped</td><td>$SKIPPED</td></tr>
              <tr><th>Total</th><th>$TOTAL</th></tr>
            </table>
          </div>
          <div class="section">
            <h2>üß† OPA Policy Validation</h2>
            <p>Total Violations: <b style="color:red;">$OPA_VIOLATIONS</b></p>
          </div>
          <div class="section" style="text-align:center;">
            <h2>üìà Overall Compliance</h2>
            <p><b>${COMPLIANCE}% Secure</b></p>
          </div>
          </body></html>
          EOF

          echo "‚úÖ compliance_dashboard.html generated successfully"
        shell: bash

      - name: üì§ Upload Unified Compliance Dashboard
        uses: actions/upload-artifact@v4
        with:
          name: compliance-dashboard
          path: compliance_dashboard.html
          if-no-files-found: error


name: üöÄ Enterprise AKS + DevOps Platform CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  security-events: write

env:
  TF_VERSION: 1.13.3
  TF_ROOT_DIR: project4-enterprise-aks-devops-platform
  IMAGE_NAME: sampleapp
  ACR_NAME: devopsacr001
  AKS_CLUSTER_NAME: devops-aks
  AKS_RESOURCE_GROUP: rg-devsecops-dev

jobs:
  terraform-validate:
    name: üß© Terraform Validate + Security Scan
    runs-on: ubuntu-latest

    steps:
      # ‚úÖ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # ‚úÖ Setup Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      # ‚úÖ Diagnostic check
      - name: Diagnostic ‚Äì Show folder structure
        run: |
          echo "=== Working Directory ==="
          pwd
          echo "=== Folder Tree ==="
          ls -R ./${{ env.TF_ROOT_DIR }}
        working-directory: ${{ github.workspace }}

      # ‚úÖ Validate Terraform directory path
      - name: Validate Terraform Path
        run: |
          TARGET_PATH="${{ github.workspace }}/${{ env.TF_ROOT_DIR }}/infrastructure/aks"
          echo "üîç Checking path: $TARGET_PATH"
          if [ ! -d "$TARGET_PATH" ]; then
            echo "‚ùå ERROR: Missing Terraform directory at $TARGET_PATH"
            ls -R ${{ github.workspace }}/${{ env.TF_ROOT_DIR }}
            exit 1
          fi
          echo "‚úÖ Terraform path confirmed: $TARGET_PATH"

      # ‚úÖ Terraform Init & Validate
      - name: Terraform Init (No Backend)
        run: terraform init -backend=false
        working-directory: ${{ env.TF_ROOT_DIR }}/infrastructure/aks

      - name: Terraform Validate
        run: terraform validate
        working-directory: ${{ env.TF_ROOT_DIR }}/infrastructure/aks

      # ‚úÖ Checkov scan (SARIF)
      - name: Checkov Scan (SARIF)
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: ${{ env.TF_ROOT_DIR }}/infrastructure/aks
          framework: terraform
          soft_fail: true
          output_format: sarif
          output_file_path: results.sarif

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif

      # ‚úÖ Generate Checkov JSON report
      - name: Generate Checkov JSON Report
        continue-on-error: true
        run: |
          echo "üßÆ Generating Checkov JSON report..."
          docker run --rm \
            -v $(pwd):/tf ghcr.io/bridgecrewio/checkov:latest \
            -d /tf/${{ env.TF_ROOT_DIR }}/infrastructure/aks \
            --framework terraform \
            --output json \
            --output-file-path /tf/checkov_report.json
        working-directory: ${{ github.workspace }}

      # ‚úÖ Build Enhanced HTML with pie chart summary
      - name: Build Enhanced HTML Report
        continue-on-error: true
        run: |
          echo "üé® Building enhanced HTML dashboard..."

          TOTAL=$(jq -r '.summary.total // (.results.passed_checks | length + .results.failed_checks | length)' checkov_report.json)
          PASSED=$(jq -r '.summary.passed // (.results.passed_checks | length)' checkov_report.json)
          FAILED=$(jq -r '.summary.failed // (.results.failed_checks | length)' checkov_report.json)
          SKIPPED=$(jq -r '.summary.skipped // 0' checkov_report.json)
          TOTAL=${TOTAL:-0}; PASSED=${PASSED:-0}; FAILED=${FAILED:-0}; SKIPPED=${SKIPPED:-0}

          echo "<html><head><title>Checkov Compliance Report</title>
          <style>
            body { font-family: Arial; background:#f8f9fa; margin:30px; }
            h1 { color:#222; }
            table { border-collapse: collapse; width:60%; margin-bottom:20px; }
            th, td { border:1px solid #ccc; padding:8px; text-align:left; }
            th { background:#343a40; color:#fff; }
            .passed { color:green; font-weight:bold; }
            .failed { color:red; font-weight:bold; }
            .skipped { color:orange; font-weight:bold; }
            .pie { width:200px; height:200px; border-radius:50%;
                   background:conic-gradient(green 0% calc(${PASSED}/${TOTAL}*100%),
                                             red calc(${PASSED}/${TOTAL}*100%) calc((${PASSED}+${FAILED})/${TOTAL}*100%),
                                             orange calc((${PASSED}+${FAILED})/${TOTAL}*100%) 100%);
                   margin:20px 0; }
            pre { background:#fff; border:1px solid #ccc; padding:10px; border-radius:6px; overflow:auto; }
          </style>
          </head><body>
          <h1>‚úÖ Checkov Terraform Compliance Summary</h1>
          <div class='pie'></div>
          <table>
            <tr><th>Status</th><th>Count</th></tr>
            <tr><td class='passed'>‚úÖ Passed</td><td>$PASSED</td></tr>
            <tr><td class='failed'>‚ùå Failed</td><td>$FAILED</td></tr>
            <tr><td class='skipped'>‚ö†Ô∏è Skipped</td><td>$SKIPPED</td></tr>
            <tr><td><b>Total</b></td><td><b>$TOTAL</b></td></tr>
          </table>
          <h2>Full JSON Report</h2><pre>" > checkov_report.html

          jq '.' checkov_report.json >> checkov_report.html
          echo "</pre></body></html>" >> checkov_report.html
        working-directory: ${{ github.workspace }}

      - name: Upload Checkov HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: checkov-html-report
          path: ${{ github.workspace }}/checkov_report.html

      # ‚úÖ Install OPA
      - name: Install OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64
          chmod +x opa
          sudo mv opa /usr/local/bin/

      # ‚úÖ Run OPA policies + generate JSON
      - name: Run OPA Policies
        continue-on-error: true
        run: |
          terraform show -json > plan.json || true
          echo "‚öôÔ∏è Running OPA policy validation..."
          opa eval --data ${{ env.TF_ROOT_DIR }}/policies/opa --input plan.json "data.terraform.policy.deny" --format=json > opa_result.json || true

          TOTAL=$(jq '.result[0].expressions[0].value | length' opa_result.json)
          TOTAL=${TOTAL:-0}

          echo "<html><head><title>OPA Policy Report</title>
          <style>body{font-family:Arial;background:#f8f9fa;margin:30px;}
          h1{color:#222;}pre{background:#fff;border:1px solid #ccc;padding:10px;border-radius:6px;}
          .passed{color:green;font-weight:bold;} .failed{color:red;font-weight:bold;}
          </style></head><body>
          <h1>üß† OPA Policy Validation Summary</h1>
          <p>Total Violations: <b class='failed'>$TOTAL</b></p>
          <h2>Details</h2><pre>" > opa_report.html
          jq '.' opa_result.json >> opa_report.html
          echo "</pre></body></html>" >> opa_report.html
        working-directory: ${{ github.workspace }}

      # ‚úÖ Combine both reports into unified dashboard
      - name: Combine Reports into Unified Dashboard
        run: |
          echo "üß± Building Unified Compliance Dashboard..."
          echo "<html><head><title>Unified DevSecOps Compliance Dashboard</title>
          <style>
            body{font-family:Arial;background:#f4f6f9;margin:20px;}
            h1{text-align:center;}
            iframe{width:48%;height:700px;border:1px solid #ccc;border-radius:8px;}
            .split{display:flex;justify-content:space-between;gap:2%;}
          </style>
          </head><body>
          <h1>üåê Enterprise AKS DevSecOps Compliance Dashboard</h1>
          <div class='split'>
            <iframe src='checkov_report.html'></iframe>
            <iframe src='opa_report.html'></iframe>
          </div>
          </body></html>" > compliance_dashboard.html
        working-directory: ${{ github.workspace }}

      - name: Upload Unified Compliance Dashboard
        uses: actions/upload-artifact@v4
        with:
          name: compliance-dashboard
          path: ${{ github.workspace }}/compliance_dashboard.html

      - name: Print Summary
        run: |
          echo "‚úÖ Terraform + Security checks completed successfully"
          echo "üìä Compliance Dashboard ready under Artifacts ‚Üí compliance-dashboard.html"
          echo "üìÑ SARIF report uploaded to Security ‚Üí Code scanning alerts"


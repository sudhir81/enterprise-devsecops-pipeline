name: üöÄ Enterprise AKS + DevSecOps Platform CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  TF_VERSION: 1.13.3
  TF_ROOT_DIR: project4-enterprise-aks-devops-platform/infrastructure/aks
  IMAGE_NAME: sampleapp
  ACR_NAME: devopsacr001
  AKS_CLUSTER_NAME: devops-aks
  AKS_RESOURCE_GROUP: rg-devsecops-dev

jobs:
  terraform-validate:
    name: üß© Terraform Validate + Security Scan
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout Code
      - name: üõ†Ô∏è Checkout Repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Terraform
      - name: ‚öôÔ∏è Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      # 3Ô∏è‚É£ Azure Login (Service Principal via JSON Creds)
      - name: üîê Azure Login (Service Principal)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          enable-AzPSSession: false
          environment: azurecloud
          allow-no-subscriptions: false

      # 4Ô∏è‚É£ Configure Terraform Azure Backend
      - name: üåç Configure Terraform Azure Backend Auth
        run: |
          echo "Setting up Terraform Azure backend authentication..."
          echo '${{ secrets.AZURE_CREDENTIALS }}' > creds.json
          echo "ARM_CLIENT_ID=$(jq -r '.clientId' creds.json)" >> $GITHUB_ENV
          echo "ARM_CLIENT_SECRET=$(jq -r '.clientSecret' creds.json)" >> $GITHUB_ENV
          echo "ARM_SUBSCRIPTION_ID=$(jq -r '.subscriptionId' creds.json)" >> $GITHUB_ENV
          echo "ARM_TENANT_ID=$(jq -r '.tenantId' creds.json)" >> $GITHUB_ENV
          echo "ARM_USE_OIDC=false" >> $GITHUB_ENV
          rm creds.json
        shell: bash

      # 5Ô∏è‚É£ Terraform Init
      - name: üöÄ Terraform Init
        run: |
          cd ${{ env.TF_ROOT_DIR }}
          terraform init -upgrade

      # 6Ô∏è‚É£ Terraform Validate
      - name: üßæ Terraform Validate
        run: |
          cd ${{ env.TF_ROOT_DIR }}
          terraform validate

      # 7Ô∏è‚É£ Terraform Plan
      - name: üìã Terraform Plan
        run: |
          cd ${{ env.TF_ROOT_DIR }}
          terraform plan -out=tfplan

      # 8Ô∏è‚É£ Run Checkov Security Scan
      - name: üß† Run Checkov Security Scan
        run: |
          docker run --rm \
            -v $(pwd):/tf ghcr.io/bridgecrewio/checkov:latest \
            -d /tf/${{ env.TF_ROOT_DIR }} \
            --framework terraform \
            --output json \
            --output-file-path /tf/checkov_report.json

      # 9Ô∏è‚É£ OPA Policy Validation
      - name: üîç Installing OPA and validating policies
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64
          chmod +x opa
          ./opa eval --format=json --data project4-enterprise-aks-devops-platform/policies/opa \
            --input checkov_report.json "data.terraform.policy.deny" > opa_result.json

      # üîü Unified Compliance Dashboard
      - name: üß± Building unified compliance dashboard
        run: |
          sudo apt-get update -qq && sudo apt-get install -y jq

          WORK_DIR=$(pwd)
          DASHBOARD_PATH="$WORK_DIR/compliance_dashboard.html"

          echo "üìÇ WORK_DIR: $WORK_DIR"
          echo "üìÑ Target dashboard path: $DASHBOARD_PATH"

          # Ensure JSON reports exist
          [ ! -s checkov_report.json ] && echo '{"summary":{"passed":0,"failed":0,"skipped":0}}' > checkov_report.json
          [ ! -s opa_result.json ] && echo '{"result":[{"expressions":[{"value":[]}]}]}' > opa_result.json

          PASSED=$(jq -r '.summary.passed // 0' checkov_report.json)
          FAILED=$(jq -r '.summary.failed // 0' checkov_report.json)
          SKIPPED=$(jq -r '.summary.skipped // 0' checkov_report.json)
          TOTAL=$((PASSED + FAILED + SKIPPED))
          [ "$TOTAL" -eq 0 ] && TOTAL=1
          OPA_VIOLATIONS=$(jq '.result[0].expressions[0].value | length' opa_result.json 2>/dev/null || echo 0)
          COMPLIANCE=$((100 * PASSED / TOTAL))

          cat > "$DASHBOARD_PATH" <<EOF
          <html><head><title>Unified Compliance Dashboard</title>
          <style>
            body{font-family:Arial;background:#f7f9fb;margin:30px;}
            h1{text-align:center;color:#0d47a1;}
            .section{background:#fff;padding:20px;border-radius:10px;margin-bottom:30px;
              box-shadow:0 2px 8px rgba(0,0,0,0.1);}
            table{width:60%;border-collapse:collapse;margin:auto;}
            th,td{border:1px solid #ddd;padding:8px;text-align:center;}
            th{background:#1976d2;color:white;}
            .passed{color:green;font-weight:bold;}
            .failed{color:red;font-weight:bold;}
            .skipped{color:orange;font-weight:bold;}
          </style></head><body>
          <h1>üåê Enterprise AKS + DevSecOps Compliance Dashboard</h1>
          <div class="section">
            <h2>‚úÖ Checkov Terraform Summary</h2>
            <table>
              <tr><th>Status</th><th>Count</th></tr>
              <tr><td class='passed'>Passed</td><td>$PASSED</td></tr>
              <tr><td class='failed'>Failed</td><td>$FAILED</td></tr>
              <tr><td class='skipped'>Skipped</td><td>$SKIPPED</td></tr>
            </table>
          </div>
          <div class="section">
            <h2>üß† OPA Policy Validation</h2>
            <p>Total Violations: <b style="color:red;">$OPA_VIOLATIONS</b></p>
          </div>
          <div class="section" style="text-align:center;">
            <h2>üìà Overall Compliance</h2>
            <p><b>${COMPLIANCE}% Secure</b></p>
          </div>
          </body></html>
          EOF

          echo "‚úÖ compliance_dashboard.html generated successfully"
        shell: bash

      # 11Ô∏è‚É£ Upload Dashboard Artifact
      - name: üì§ Upload Unified Compliance Dashboard
        uses: actions/upload-artifact@v4
        with:
          name: compliance-dashboard
          path: compliance_dashboard.html
          if-no-files-found: error

